---
globs: ["secrets/**/*.yaml", ".sops.yaml", "hosts/*/default.nix"]
description: sops-nix secrets management standards
---

# Secrets: sops-nix Standards

**All secrets via sops-nix. Never plaintext in repo.**

## Required Setup
```yaml
# .sops.yaml in repo root
keys:
  - &admin age1your-key-here
  - &host age1host-key-here

creation_rules:
  - path_regex: secrets/.*\.yaml$
    key_groups:
      - age: [*admin, *host]
```

## Structure
```
secrets/
├── common.yaml          # Shared across all hosts
└── hosts/
    └── <hostname>.yaml  # Host-specific secrets
```

## Host Integration
```nix
# hosts/prod-1/default.nix
sops = {
  defaultSopsFile = ../../secrets/hosts/prod-1.yaml;
  age.keyFile = "/etc/ssh/ssh_host_ed25519_key";
  
  secrets.db_password = {
    owner = "postgres";
  };
};
```

## Enforcement
- ❌ Plaintext credentials anywhere in repo
- ✅ All `.yaml` in secrets/ are encrypted (verify with `file`)
- ✅ `.sops.yaml` committed to git
- ✅ Private age keys NOT in repo (in password manager)

## Key Management
```bash
# Generate host key (converted from SSH)
nix-shell -p ssh-to-age
ssh-to-age < /etc/ssh/ssh_host_ed25519_key.pub
```

See report lines 287-385 for complete workflow.
